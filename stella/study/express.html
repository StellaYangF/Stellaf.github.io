<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>What is express? | Hi, I&#39;m here</title>
    <meta name="description" content="Stella Blog">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/stella/cute.gif">
    
    <link rel="preload" href="/stella/assets/css/0.styles.bea9ebe4.css" as="style"><link rel="preload" href="/stella/assets/js/app.a2432007.js" as="script"><link rel="preload" href="/stella/assets/js/2.2386d97d.js" as="script"><link rel="preload" href="/stella/assets/js/14.64675c80.js" as="script"><link rel="preload" href="/stella/assets/js/3.110e554a.js" as="script"><link rel="prefetch" href="/stella/assets/js/10.fd4ad1c1.js"><link rel="prefetch" href="/stella/assets/js/11.3a5da84d.js"><link rel="prefetch" href="/stella/assets/js/12.7fc9b655.js"><link rel="prefetch" href="/stella/assets/js/13.1ea7d7af.js"><link rel="prefetch" href="/stella/assets/js/15.8ddf4f14.js"><link rel="prefetch" href="/stella/assets/js/16.21e8f61a.js"><link rel="prefetch" href="/stella/assets/js/17.43fe9af9.js"><link rel="prefetch" href="/stella/assets/js/18.9a7318c0.js"><link rel="prefetch" href="/stella/assets/js/19.9f6f7f58.js"><link rel="prefetch" href="/stella/assets/js/20.6cd1af63.js"><link rel="prefetch" href="/stella/assets/js/21.0956db65.js"><link rel="prefetch" href="/stella/assets/js/22.7206555d.js"><link rel="prefetch" href="/stella/assets/js/4.a89924df.js"><link rel="prefetch" href="/stella/assets/js/5.ef4b734f.js"><link rel="prefetch" href="/stella/assets/js/6.d652d8c3.js"><link rel="prefetch" href="/stella/assets/js/7.272949a8.js"><link rel="prefetch" href="/stella/assets/js/8.4414a10d.js"><link rel="prefetch" href="/stella/assets/js/9.af90e5d2.js">
    <link rel="stylesheet" href="/stella/assets/css/0.styles.bea9ebe4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/stella/" class="home-link router-link-active"><!----> <span class="site-name">Hi, I'm here</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link router-link-exact-active router-link-active">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/interview.html" class="nav-link">
  interview
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link router-link-exact-active router-link-active">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/interview.html" class="nav-link">
  interview
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>What is express?</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/stella/study/express.html#新建-app-js" class="sidebar-link">新建 app.js</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#引入依赖模块" class="sidebar-link">引入依赖模块</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#user-路由下的请求" class="sidebar-link">user 路由下的请求</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#app-应用的请求" class="sidebar-link">app 应用的请求</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#注册-user-二级路由系统" class="sidebar-link">注册 user 二级路由系统</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#错误捕获处理" class="sidebar-link">错误捕获处理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#监听端口" class="sidebar-link">监听端口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#express-核心概念" class="sidebar-link">express 核心概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#outlet-structure-目录结构" class="sidebar-link">outlet structure 目录结构</a></li></ul></li><li><a href="/stella/study/express.html#express-index-js" class="sidebar-link">express/index.js</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/express.html#express-lib-express-js" class="sidebar-link">express/lib/express.js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#引入-application-应用系统-和-router-路由系统" class="sidebar-link">引入 Application 应用系统 和 Router 路由系统</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#createapplication-实例化应用实例的函数" class="sidebar-link">createApplication 实例化应用实例的函数</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#给函数添加-router-属性" class="sidebar-link">给函数添加 Router 属性</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#导出函数" class="sidebar-link">导出函数</a></li></ul></li><li><a href="/stella/study/express.html#express-lib-application-js" class="sidebar-link">/study/express.html#express-lib-application-js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#下载第三方工具库" class="sidebar-link">下载第三方工具库</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#引入依赖包" class="sidebar-link">引入依赖包</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#创建-application-类" class="sidebar-link">创建 Application 类</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#set-实例方法" class="sidebar-link">set 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#layze-route-实例方法" class="sidebar-link">layze_route 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#param-实例方法" class="sidebar-link">param 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#use-实例方法" class="sidebar-link">use 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#method-实例方法" class="sidebar-link">method 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#listen-实例方法" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#导出-application-类" class="sidebar-link">导出 Application 类</a></li></ul></li><li><a href="/stella/study/express.html#express-lib-router-index-js" class="sidebar-link">/study/express.html#express-lib-router-index-js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#引入依赖模块-2" class="sidebar-link">引入依赖模块</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#声明一个-proto-对象" class="sidebar-link">声明一个 proto 对象</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#创建-router-类" class="sidebar-link">创建 Router 类</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#param-方法" class="sidebar-link">param 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#route-方法" class="sidebar-link">route 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#use-方法" class="sidebar-link">use 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#get-post-delete-update-方法" class="sidebar-link">get/ post/ delete/ update ... 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#process-params-参数方法" class="sidebar-link">process_params 参数方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#handle-方法" class="sidebar-link">handle 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#导出-router-类" class="sidebar-link">导出 Router 类</a></li></ul></li><li><a href="/stella/study/express.html#express-lib-router-layer-js" class="sidebar-link">/study/express.html#express-lib-router-layer-js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#下载依赖包" class="sidebar-link">下载依赖包</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#引入依赖包-2" class="sidebar-link">引入依赖包</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#创建-layer-类" class="sidebar-link">创建 Layer 类</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#match-方法" class="sidebar-link">match 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#handle-request-方法" class="sidebar-link">handle_request 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#handle-err-方法" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#导出-layer-类" class="sidebar-link">导出 Layer 类</a></li></ul></li><li><a href="/stella/study/express.html#express-lib-router-route-js" class="sidebar-link">/study/express.html#express-lib-router-route-js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/express.html#引入依赖包-3" class="sidebar-link">引入依赖包</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#创建-route-类" class="sidebar-link">创建 Route 类</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#dispatch-实例方法" class="sidebar-link">dispatch 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#method-实例方法-2" class="sidebar-link">[method] 实例方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/express.html#导出-route-类" class="sidebar-link">导出 Route 类</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="what-is-express"><a href="#what-is-express" class="header-anchor">#</a> What is <code>express</code>?</h1> <p><em><strong>Fast, unopinionated, minimalist web framework for node.</strong></em> <a href="https://www.npmjs.com/package/express" target="_blank" rel="noopener noreferrer">express<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个基于 <code>node</code> 的 web 服务器，其特点是：快速、简单、小型。</p> <p>特点：</p> <ul><li>Robust routing 强大的路由系统</li> <li>Focus on high performance 高性能</li> <li>Super-high test coverage 测试覆盖率超高</li> <li>HTTP helpers (redirection, caching, etc) <code>HTTP</code> 各种助力如重定向、缓存等</li> <li>View system supporting 14+ template engines 支持 14种以上的视图引擎</li> <li>Content negotiation 内容协商?</li> <li>Executable for generating applications quickly 快速可执行的运用程序</li></ul> <p>最开始接触 <code>node</code> 的时候，用过的后台框架就是 <code>express</code>，当时只能根据官网的 <code>documentation API</code> 写最简单的几个接口。相比 <code>koa</code> （二者参考比较见 <a href="https://juejin.im/post/5e564b426fb9a07caf445c97" target="_blank" rel="noopener noreferrer">koa | analysis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），内部继承了开发中可能用到的包模块，直接引入即可，无需另行下载依赖。现有 <a href="https://www.npmjs.com/package/express-generator" target="_blank" rel="noopener noreferrer">express-generator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 脚手架，全局下载安装就能使用啦~</p> <p>话不多说，直入正题。</p> <h1 id="init-project-初始化项目"><a href="#init-project-初始化项目" class="header-anchor">#</a> Init project 初始化项目</h1> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> express_practice
<span class="token builtin class-name">cd</span> express_practice
<span class="token function">npm</span> init -y
</code></pre></div></div> <h1 id="installation-安装"><a href="#installation-安装" class="header-anchor">#</a> Installation 安装</h1> <p>This is a Node.js module available through the npm registry.
express 是一个 node 模块，可通过 <code>npm registry</code> 仓库下载。
Before installing, download and install Node.js. Node.js 0.10 or higher is required.
首先，你得下载、安装 node &gt; 0.10 版本
Installation is done using the npm install command:
使用 <code>npm install</code> 命令行完成下载。</p> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i express --save
or
<span class="token function">npm</span> i express
or
<span class="token function">npm</span> i express -S
</code></pre></div></div> <h1 id="usage-使用"><a href="#usage-使用" class="header-anchor">#</a> Usage 使用</h1> <h2 id="新建-app-js"><a href="#新建-app-js" class="header-anchor">#</a> 新建 app.js</h2> <p>创建 web 应用程序的文件。</p> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">touch</span> app.js
</code></pre></div></div> <h2 id="引入依赖模块"><a href="#引入依赖模块" class="header-anchor">#</a> 引入依赖模块</h2> <ul><li>express 核心模块</li> <li>app.Router 是一个类</li> <li>user 是一个二级路由实例</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> app<span class="token punctuation">.</span>Router<span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="user-路由下的请求"><a href="#user-路由下的请求" class="header-anchor">#</a> user 路由下的请求</h2> <ul><li>三个参数</li> <li>next 调用不传参，就是让路由系统在没有匹配的路径和方法时，往下一个中间件走；传入参数就是抛出错误</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/remove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/user/remove</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/add&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'/user/add'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h2 id="app-应用的请求"><a href="#app-应用的请求" class="header-anchor">#</a> app 应用的请求</h2> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h2 id="注册-user-二级路由系统"><a href="#注册-user-二级路由系统" class="header-anchor">#</a> 注册 user 二级路由系统</h2> <ul><li>注册中间件</li> <li>接口一： /user/remove</li> <li>接口二： /user/add</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="错误捕获处理"><a href="#错误捕获处理" class="header-anchor">#</a> 错误捕获处理</h2> <ul><li>错误中间件</li> <li>四个参数，第一个参数就是捕获的错误</li> <li>该错误是由前面请求中，调用 next</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h2 id="监听端口"><a href="#监听端口" class="header-anchor">#</a> 监听端口</h2> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="express-核心概念"><a href="#express-核心概念" class="header-anchor">#</a> express 核心概念</h2> <p>express 核心用到的就是 commonjs 规范，基本都是基于回调实现的中间件与请求。</p> <h3 id="outlet-structure-目录结构"><a href="#outlet-structure-目录结构" class="header-anchor">#</a> outlet structure 目录结构</h3> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code>└──express
   ├──index.js
   └──lib
       ├──express.js
       ├──application.js
       └──router
           ├──index.js
           ├──layer.js
           └──route.js
</code></pre></div></div> <h1 id="fulfill-实现"><a href="#fulfill-实现" class="header-anchor">#</a> Fulfill 实现</h1> <p>新建包文件及其子文件</p> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> express <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> express
<span class="token function">touch</span> index.js
<span class="token function">mkdir</span> lib <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> lib
<span class="token function">touch</span> express.js
<span class="token function">touch</span> application.js
<span class="token function">mkdir</span> router <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> router
<span class="token function">touch</span> index.js
<span class="token function">touch</span> layer.js
<span class="token function">touch</span> route.js
</code></pre></div></div> <h2 id="express-index-js"><a href="#express-index-js" class="header-anchor">#</a> express/index.js</h2> <p>express 本质就是一个函数，调用后就返回一个 <code>Application</code> 运用类实例</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./lib/express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <blockquote><p>express 采用的是 commonjs 规范。文件的导出和引入分别是: <code>require()</code>, <code>module.exports</code>。</p></blockquote> <h2 id="express-lib-express-js"><a href="#express-lib-express-js" class="header-anchor">#</a> express/lib/express.js</h2> <h3 id="引入-application-应用系统-和-router-路由系统"><a href="#引入-application-应用系统-和-router-路由系统" class="header-anchor">#</a> 引入 <code>Application</code> 应用系统 和 <code>Router</code> 路由系统</h3> <ul><li><strong>应用</strong> 和 <strong>路由</strong> 两大系统各司其职。</li> <li><code>createApplication</code> 为工厂函数，函数体内实例化一个 <a href="#application"><code>Application</code></a> 实例对象并返回，为每一个引入 <code>express</code> 包模块产生一个独立的 应用实例。</li> <li><code>createApplication.Router</code> 挂载的是一个 Router 类，将路由系统独立使用。</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Application <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./application'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="createapplication-实例化应用实例的函数"><a href="#createapplication-实例化应用实例的函数" class="header-anchor">#</a> <code>createApplication</code> 实例化应用实例的函数</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="给函数添加-router-属性"><a href="#给函数添加-router-属性" class="header-anchor">#</a> 给函数添加 Router 属性</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>createApplication<span class="token punctuation">.</span>Router <span class="token operator">=</span> Router<span class="token punctuation">;</span>
</code></pre></div></div> <blockquote><p>注意：函数也是一个对象，可以添加属性。</p></blockquote> <h3 id="导出函数"><a href="#导出函数" class="header-anchor">#</a> 导出函数</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> createApplication<span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="express-lib-application-js"><a href="#express-lib-application-js" class="header-anchor">#</a> <span id="application">express/lib/application.js</span></h2> <h3 id="下载第三方工具库"><a href="#下载第三方工具库" class="header-anchor">#</a> 下载第三方工具库</h3> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i methods --save
</code></pre></div></div> <h3 id="引入依赖包"><a href="#引入依赖包" class="header-anchor">#</a> 引入依赖包</h3> <ul><li><code>http</code> <code>node</code> 核心模块，不需要下载安装，用来调用 <code>http.createServer()</code> 创建一个 web 服务。</li> <li><code>Router</code> 路由系统类，详情见 <a href="#router">router.js</a></li> <li><code>methods</code> 第三方库 <code>declare const methods: string[];</code></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'methods'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="创建-application-类"><a href="#创建-application-类" class="header-anchor">#</a> 创建 <code>Application</code> 类</h3> <ul><li>实例属性 <code>config</code></li> <li>实例属性 <code>_router</code>，后续会记性优化*</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="set-实例方法"><a href="#set-实例方法" class="header-anchor">#</a> set 实例方法</h3> <ul><li>参数为2个时，设置操作</li> <li>参数为1个时，取值操作</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="layze-route-实例方法"><a href="#layze-route-实例方法" class="header-anchor">#</a> layze_route 实例方法</h3> <p>性能优化：</p> <ul><li>修改 constructor 里的实例属性。</li> <li>取代 Application 一旦实例化，就初始 _router 属性，客户端如果不调用 (any method)请求 | param 方法，只是调用了 use 方法，就会造成性能浪费。</li> <li>_router 只有一个，也就是只需要实例化一次进行赋值。</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
     <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">-</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">lazy_route</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="param-实例方法"><a href="#param-实例方法" class="header-anchor">#</a> param 实例方法</h3> <p>具体实现都交给 _router 路由系统来处理</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="use-实例方法"><a href="#use-实例方法" class="header-anchor">#</a> use 实例方法</h3> <p>具体实现都交给 _router 路由系统来处理</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="method-实例方法"><a href="#method-实例方法" class="header-anchor">#</a> method 实例方法</h3> <p>具体实现都交给 _router 路由系统来处理
可传入多个回调函数 <code>handlers</code></p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> <span class="token operator">...</span>handlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'get'</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">...</span>handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h3 id="listen-实例方法"><a href="#listen-实例方法" class="header-anchor">#</a> <span id="listen">listen 实例方法</span></h3> <ul><li>调用<code>http.createServer(function(req, res))</code>, 创建一个 server 服务；</li> <li>准备一个 <code>done</code> 方法，供路由系统没有匹配的路由(方法和路径)时使用，调也就是 <code>next</code> 方法；</li> <li>调用 <code>_router.handle</code>，传入<code>req</code>, <code>res</code>, <code>done</code>三个参数，让路由系统来处理请求，并作出响应；</li> <li>指定监听的端口号，选择性传入回调函数。</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>
<span class="token class-name">Application</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http<span class="token punctuation">.</span>createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lazy_route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>send <span class="token operator">=</span> res<span class="token punctuation">.</span>end<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="导出-application-类"><a href="#导出-application-类" class="header-anchor">#</a> 导出 <code>Application</code> 类</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Application<span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="express-lib-router-index-js"><a href="#express-lib-router-index-js" class="header-anchor">#</a> <span id="router">express/lib/router/index.js</span></h2> <h3 id="引入依赖模块-2"><a href="#引入依赖模块-2" class="header-anchor">#</a> 引入依赖模块</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'methods'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Route <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./route'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Layer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./layer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="声明一个-proto-对象"><a href="#声明一个-proto-对象" class="header-anchor">#</a> 声明一个 <code>proto</code> 对象</h3> <ul><li>供 <code>Router</code> 类的构造函数内部的 <code>router</code> 函数继承</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="创建-router-类"><a href="#创建-router-类" class="header-anchor">#</a> 创建 <code>Router</code> 类</h3> <ul><li><p><code>constructor</code> 函数内部返回一个 <code>router</code> 函数，且该函数包含多个属性/方法</p></li> <li><p>为什么要重写构造函数？</p> <ul><li>供二级路由使用</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// user 就是一个中间件，</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">app<span class="token punctuation">.</span>Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// application 实例调用 use 时，会把 req, res, next 传入 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// user 函数调用就是 router 调用，进而调用 router.handle 函数</span>
</code></pre></div></div></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">router</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        router<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    router<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    router<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> proto<span class="token punctuation">;</span>
    router<span class="token punctuation">.</span>paramsCallback <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// { key: [fn, fn] }</span>
    <span class="token keyword">return</span> router<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>注意：</p></blockquote> <ul><li><p>可以简单粗暴的理解 <code>router</code> 的<strong>机制</strong>，就是经典的 <code>发布订阅</code> 模式；</p></li> <li><p>订阅阶段：</p> <p>调用 <code>use/ get/ post/ ...</code> 时，就是往 <code>stack</code> 数组中添加一层 <a href="#layer">layer</a></p></li> <li><p>发布阶段：</p> <ul><li>调用 <code>app.listen()</code> 时，见 <a href="#listen">Application.prototype.listen</a></li></ul></li> <li><p><code>Router</code> 的实例化有两种情况：</p> <ul><li>调用 <code>app[method](path, handlers)</code> 的时候</li> <li>调用 <code>app.Router</code> 进行二级路由的实例</li></ul></li></ul> <h3 id="param-方法"><a href="#param-方法" class="header-anchor">#</a> param 方法</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>proto<span class="token punctuation">.</span><span class="token function-variable function">param</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>paramsCallback<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>paramsCallback<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>paramsCallback<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>handler<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="route-方法"><a href="#route-方法" class="header-anchor">#</a> route 方法</h3> <ul><li>实例化一条 <code>route</code> 路由</li> <li>实例化一个 <code>layer</code> 层</li> <li>完成一条订阅</li> <li>返回这个 <code>route</code></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>proto<span class="token punctuation">.</span><span class="token function-variable function">route</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> route<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    layer<span class="token punctuation">.</span>route <span class="token operator">=</span> route<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> route<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="use-方法"><a href="#use-方法" class="header-anchor">#</a> use 方法</h3> <ul><li>调用 route 方法</li> <li>实例化一个 <code>layer</code> 层</li> <li><code>layer.route</code> 设置为 <code>undefined</code> 值，方便在发布的时候判断为普通中间件，内部没有 <code>route</code> 路由</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>proto<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       handler <span class="token operator">=</span> path<span class="token punctuation">;</span>
       path <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    layer<span class="token punctuation">.</span>route <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="get-post-delete-update-方法"><a href="#get-post-delete-update-方法" class="header-anchor">#</a> get/ post/ delete/ update ... 方法</h3> <ul><li>每调用一次，就新加一层 <code>layer</code></li> <li>触发 <code>route[method]</code></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    proto<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> <span class="token operator">...</span>handlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> route <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        route<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h3 id="process-params-参数方法"><a href="#process-params-参数方法" class="header-anchor">#</a> process_params 参数方法</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>proto<span class="token punctuation">.</span><span class="token function-variable function">process_params</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>keys <span class="token operator">||</span> layer<span class="token punctuation">.</span>keys<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// key [id, name]</span>
    <span class="token keyword">let</span> keys <span class="token operator">=</span> layer<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramsCallback<span class="token punctuation">;</span>
    <span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keys<span class="token punctuation">.</span>length <span class="token operator">===</span> idx<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">processCallback</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">processCallback</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> out</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> fns <span class="token operator">=</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length <span class="token operator">===</span> idx<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> fn <span class="token operator">=</span> fns<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">fn</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">,</span> value<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="handle-方法"><a href="#handle-方法" class="header-anchor">#</a> handle 方法</h3> <ul><li>发布之前订阅的方法 | 中间件；</li> <li><code>out</code> 函数就是 <a href="#listen">Application.prototype.listen</a> 内部传入的 <code>done</code> 方法，表示结束；</li> <li><code>dispatch</code> 为核心方法，采用递归方式；</li> <li><code>removed</code> 为二级路由的子路径，当请求路径为/user/add， 第一轮匹配 <code>/user</code> 时，会先删除，再进一步往 route 层 处理，此时路径为 /add，当 /add 无法匹配，则递归调用 <code>dispatch</code> 调用下一个 layer，再把 /user 追加回来。</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>proto<span class="token punctuation">.</span><span class="token function-variable function">handle</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> out</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 stack 第一个层开始处理</span>
    <span class="token keyword">let</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> removed <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 核心方法 err 是 next 函数调用传来的，表示错误捕获</span>
    <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// stack 为空，直接 out</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 若 removed 有值没说明上一轮匹配失败，本轮重新匹配，再次追加上</span>
        <span class="token comment">// 清空 removed</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            req<span class="token punctuation">.</span>url <span class="token operator">=</span> removed <span class="token operator">+</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
            removed <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取当前 layer 层，并 把指针向下引</span>
        <span class="token keyword">let</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 若捕获到错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当前 layer 不是错误中间件，交给 layer 错误处理，不会往下走</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                layer<span class="token punctuation">.</span><span class="token function">handle_err</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 当前就是错误捕获中间件 app.use((err, req, res, next) =&gt; {})</span>
                <span class="token comment">// 交给它处理</span>
                <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 没有错误 且匹配到</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>rout<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果是中间件 直接执行 对应的方法即可</span>
                    <span class="token comment">// 在这里把中间件的路径 删除掉</span>
                    <span class="token comment">// /user/add   /</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>path <span class="token operator">!==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果中间件就是/</span>
                            removed <span class="token operator">=</span> layer<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
                            req<span class="token punctuation">.</span>url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>removed<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                        layer<span class="token punctuation">.</span><span class="token function">handle_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 路由</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>route<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        req<span class="token punctuation">.</span>params <span class="token operator">=</span> layer<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
                       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">process_params</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                          layer<span class="token punctuation">.</span><span class="token function">handle_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="导出-router-类"><a href="#导出-router-类" class="header-anchor">#</a> 导出 <code>Router</code> 类</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Router<span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="express-lib-router-layer-js"><a href="#express-lib-router-layer-js" class="header-anchor">#</a> <span id="layer">express/lib/router/layer.js</span></h2> <h3 id="下载依赖包"><a href="#下载依赖包" class="header-anchor">#</a> 下载依赖包</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>npm i path<span class="token operator">-</span>to<span class="token operator">-</span>regexp <span class="token operator">--</span>save
</code></pre></div></div> <h3 id="引入依赖包-2"><a href="#引入依赖包-2" class="header-anchor">#</a> 引入依赖包</h3> <ul><li><a href="https://www.npmjs.com/package/path-to-regexp" target="_blank" rel="noopener noreferrer">path-to-regexp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> pathToRegexp <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path-to-regexp'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="创建-layer-类"><a href="#创建-layer-类" class="header-anchor">#</a> 创建 Layer 类</h3> <p>层的运用在两个场景</p> <ul><li>在 <code>Router.stack</code> 中，每一个数组元素都是 <code>layer</code>；</li> <li>在 <code>Route.stack</code> 中，同上。</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Layer</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reg <span class="token operator">=</span> <span class="token function">pathToRegexp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="match-方法"><a href="#match-方法" class="header-anchor">#</a> match 方法</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">match</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">pathname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> match <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> current<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>memo<span class="token punctuation">[</span>current<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> match<span class="token punctuation">[</span>index<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memo<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">===</span> pathname<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token operator">+</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="handle-request-方法"><a href="#handle-request-方法" class="header-anchor">#</a> handle_request 方法</h3> <p>核心</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">handle_request</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="handle-err-方法"><a href="#handle-err-方法" class="header-anchor">#</a> <span id="handle_err">handle_err 方法</span></h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Layer</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">handle_err</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可能是错误中间件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="导出-layer-类"><a href="#导出-layer-类" class="header-anchor">#</a> 导出 Layer 类</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Layer<span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="express-lib-router-route-js"><a href="#express-lib-router-route-js" class="header-anchor">#</a> <span id="route">express/lib/router/route.js</span></h2> <h3 id="引入依赖包-3"><a href="#引入依赖包-3" class="header-anchor">#</a> 引入依赖包</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'methods'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Layer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./layer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="创建-route-类"><a href="#创建-route-类" class="header-anchor">#</a> 创建 <code>Route</code> 类</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Route</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>methods 实例方法用来快速定位当前的 匹配方法是否正确，节约性能</p></blockquote> <h3 id="dispatch-实例方法"><a href="#dispatch-实例方法" class="header-anchor">#</a> dispatch 实例方法</h3> <p>核心</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Route</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> out</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">out</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">out</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> layer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token punctuation">.</span>method <span class="token operator">===</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            layer<span class="token punctuation">.</span><span class="token function">handle_request</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="method-实例方法-2"><a href="#method-实例方法-2" class="header-anchor">#</a> [method] 实例方法</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">Route</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">handlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handlers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">handler</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> layer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            layer<span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token punctuation">;</span> <span class="token comment">// 用户调用什么方法 存入method就是什么</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>methods<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 如果用户绑定方法 我就记录一下</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="导出-route-类"><a href="#导出-route-类" class="header-anchor">#</a> 导出 Route 类</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Route<span class="token punctuation">;</span>
</code></pre></div></div> <h1 id="done"><a href="#done" class="header-anchor">#</a> DONE</h1> <p>写了好久，告一段落 - 后续补上一个简单的图以便更好理解学习。</p> <p>文中若有误，欢迎指正。</p> <p>一篇文章写到快转钟，连坐好几个小时，还有点上头呢。</p> <p>Good news~~~</p> <p>今天听到了好消息，就是武汉所有的方舱医院已休仓，我们的祖国计是伟大呢，现在就是要开始倒计时复工了呢~</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/stella/assets/js/app.a2432007.js" defer></script><script src="/stella/assets/js/2.2386d97d.js" defer></script><script src="/stella/assets/js/14.64675c80.js" defer></script><script src="/stella/assets/js/3.110e554a.js" defer></script>
  </body>
</html>
