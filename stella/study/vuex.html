<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>What | Hi, I&#39;m here</title>
    <meta name="description" content="Stella Blog">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/stella/cute.gif">
    
    <link rel="preload" href="/stella/assets/css/0.styles.d179d36e.css" as="style"><link rel="preload" href="/stella/assets/js/app.f51058f0.js" as="script"><link rel="preload" href="/stella/assets/js/2.15e74eba.js" as="script"><link rel="preload" href="/stella/assets/js/18.30763b5e.js" as="script"><link rel="preload" href="/stella/assets/js/3.c735cdfb.js" as="script"><link rel="prefetch" href="/stella/assets/js/10.da094dd3.js"><link rel="prefetch" href="/stella/assets/js/11.4b21daf7.js"><link rel="prefetch" href="/stella/assets/js/12.a8b22c2f.js"><link rel="prefetch" href="/stella/assets/js/13.5b958a81.js"><link rel="prefetch" href="/stella/assets/js/14.63727d7e.js"><link rel="prefetch" href="/stella/assets/js/15.f9f9828f.js"><link rel="prefetch" href="/stella/assets/js/16.f946534f.js"><link rel="prefetch" href="/stella/assets/js/17.60ec6eb6.js"><link rel="prefetch" href="/stella/assets/js/19.aff3d643.js"><link rel="prefetch" href="/stella/assets/js/20.efeb6ad1.js"><link rel="prefetch" href="/stella/assets/js/4.1d17caf9.js"><link rel="prefetch" href="/stella/assets/js/5.a25713e0.js"><link rel="prefetch" href="/stella/assets/js/6.1cc38246.js"><link rel="prefetch" href="/stella/assets/js/7.0a0d8346.js"><link rel="prefetch" href="/stella/assets/js/8.0b4789bd.js"><link rel="prefetch" href="/stella/assets/js/9.a80e4340.js">
    <link rel="stylesheet" href="/stella/assets/css/0.styles.d179d36e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/stella/" class="home-link router-link-active"><!----> <span class="site-name">Hi, I'm here</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link router-link-exact-active router-link-active">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link router-link-exact-active router-link-active">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>What</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/stella/study/vuex.html#新建-store-仓库文件" class="sidebar-link">新建 store 仓库文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/vuex.html#组件中使用" class="sidebar-link">组件中使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/vuex.html#application-structure-目录结构" class="sidebar-link">Application Structure 目录结构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/vuex.html#核心入口文件" class="sidebar-link">核心入口文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/vuex.html#store-js" class="sidebar-link">store.js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#实现-install-方法" class="sidebar-link">实现 install 方法</a></li><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#实现-store-类" class="sidebar-link">实现 Store 类</a></li><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#store-数据结构" class="sidebar-link">Store 数据结构</a></li><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#modulecollection-类结构" class="sidebar-link">ModuleCollection 类结构</a></li><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#helpers-js" class="sidebar-link">helpers.js</a></li><li class="sidebar-sub-header"><a href="/stella/study/vuex.html#工具函数" class="sidebar-link">工具函数</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="what"><a href="#what" class="header-anchor">#</a> What</h1> <p>Vuex 是一个专为 Vue.js 应用程序开发的状态管理模式。它采用集中式存储管理应用的所有组件的状态，并以相应的规则保证状态只能通过可预测的方式改变。<a href="https://vuex.vuejs.org/#what-is-vuex" target="_blank" rel="noopener noreferrer">查看官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="why"><a href="#why" class="header-anchor">#</a> Why</h1> <p>多组件共享同一个状态时，会依赖同一状态
单一数据流无法满足需求：</p> <ul><li>深度嵌套组件级属性传值，会变得非常麻烦</li> <li>同级（兄弟）组件间传值也行不通</li> <li>通过事件或父子组件直接引用也很繁琐</li></ul> <p>最终导致代码维护困难。</p> <p>multiple components that share a common state:
多组件共享状态
如下图：
<img src="https://user-gold-cdn.xitu.io/2020/5/11/17203fa2d48a2ba5?w=701&amp;h=551&amp;f=png&amp;s=8112" alt="vuex"></p> <ul><li>可追踪状态改变</li> <li>可维护</li> <li>可进行 <strong>time travel</strong></li></ul> <blockquote><p>Vue.js 官网文档写得很详细，建议初学者一定要把文档至少过一遍。</p></blockquote> <p>这里附上文档地址 <a href="https://vuex.vuejs.org/installation.html" target="_blank" rel="noopener noreferrer">Vuex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h1 id="when"><a href="#when" class="header-anchor">#</a> When</h1> <ul><li>当构建一个大型的 SPA 时</li> <li>多组件共享一个状态</li></ul> <h1 id="implement"><a href="#implement" class="header-anchor">#</a> Implement</h1> <p>解析源码之前，至少要对 Vuex 非常熟悉，再进一步实现。</p> <h2 id="新建-store-仓库文件"><a href="#新建-store-仓库文件" class="header-anchor">#</a> 新建 store 仓库文件</h2> <p>在初始化 store.js 文件时，需要手动注册 <strong>Vuex</strong>，这一步是为了将 <strong>store</strong> 属性注入到每个组件的实例上，可通过 <strong>this.$store.state</strong> 获取共享状态。</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
</code></pre></div></div> <blockquote><p>Tip: 这里 Vue 是在进行订阅，Vuex.install 函数，根组件在实例化时，会自动派发执行 install 方法，并将 Vue 作为参数传入。</p></blockquote> <p>导出 Store 实例，传入属性对象，可包含以下属性：</p> <ul><li><strong>state</strong>: 根状态</li> <li><strong>getters</strong>: 依赖状态计算出派生状态</li> <li><strong>mutations</strong>: 通过 commit</li> <li><strong>commit</strong> 改变状态的唯一方式，使得状态变化可追踪，传入 payload 作为第二参数</li> <li><strong>actions</strong>: 类似于 <strong>mutation</strong>，内部执行 <strong>commit</strong>，异步请求和操作放这里执行，外部触发调用 dispatch</li> <li><strong>dispatch</strong> 方法，传入 payload 作为第二个参数</li> <li><strong>modules</strong>: 子模块状态</li> <li><strong>namespaced</strong>: 字模块设置命名空间</li> <li><strong>strict</strong>: 严格模式</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>
    todos<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'Vue.js'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'Vuex'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'Vue-router'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'Node.js'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  getters<span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token function">doneTodosCount</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">todo</span> <span class="token operator">=&gt;</span> todo<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">syncTodoDone</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>todos<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">todo<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> index<span class="token operator">===</span>id <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>todo<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">asyncChange</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commit<span class="token punctuation">}</span><span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'syncChange'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  modules<span class="token operator">:</span> <span class="token punctuation">{</span>
    a<span class="token operator">:</span> <span class="token punctuation">{</span>
      state<span class="token operator">:</span> <span class="token punctuation">{</span>
        age<span class="token operator">:</span> <span class="token string">'18'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      mutations<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">syncAgeIncrement</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state<span class="token punctuation">.</span>age <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 这里的 state 为当前子模块状态</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>a<span class="token punctuation">.</span>age <span class="token comment">// -&gt; &quot;18&quot;</span>
</code></pre></div></div> <h2 id="组件中使用"><a href="#组件中使用" class="header-anchor">#</a> 组件中使用</h2> <p>引入相关映射函数</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mapState<span class="token punctuation">,</span> mapGetters<span class="token punctuation">,</span> mapActions<span class="token punctuation">,</span> mapMutations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>
</code></pre></div></div> <p>组件中使用时，这四种映射函数用法差不多，都是返回一个对象。</p> <p>方式一：</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">todos</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>todos<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>a<span class="token punctuation">.</span>age
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>Tip: 上述方式在获取多个状态时，代码重复过多且麻烦，<strong>this.$store.state</strong>，可进一步优化为第二种方式</p></blockquote> <p>方式二：</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  computed<span class="token operator">:</span> <span class="token function">mapState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">todos</span><span class="token operator">:</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>age<span class="token punctuation">,</span>
    
    <span class="token comment">// or</span>
    todos<span class="token operator">:</span> <span class="token string">'todos'</span><span class="token punctuation">,</span> <span class="token comment">// 属性名为别名</span>

    <span class="token comment">// or</span>
    <span class="token function">todos</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> state<span class="token punctuation">.</span>todos<span class="token punctuation">;</span> <span class="token comment">// 内部可获取 this 获取当前实例数据</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>可以看到上述的状态映射，调用时可传入 options  对象，属性值有三种形式：</p> <ul><li>箭头函数（简洁）</li> <li>字符串（别名）</li> <li>normal 函数（this 指向向前组件实例）</li></ul> <blockquote><p>Tip: 如果当前实例组件，有自己的私有的计算属性时，可使用 <strong>es6</strong> 语法的 <strong>Object Spread Operator</strong> 对象展开运算符</p></blockquote> <p>方式三：</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapState</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token string">'todos'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    otherValue<span class="token operator">:</span> <span class="token string">'other value'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>在子模块状态属性中添加 <strong>namespaced: true</strong>  字段时，<strong>mapMutations</strong>, <strong>mapActions</strong> 需要添加对应的命名空间
方式一：</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">syncTodoDone</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'syncTodoDone'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">syncAgeIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'syncAgeIncrement'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>方式二：</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token string">&quot;syncTodoDone&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;asyncIncrement&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>方式三：
借助 <strong>vuex</strong> 内部帮助函数进行包装</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createNamespacedHelpers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> mapMutations <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createNamespacedHelpers</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>
  methods<span class="token operator">:</span> <span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">'syncAgeIncrement'</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>除了以上基础用法之外，还有 <strong>plugins</strong>, <strong>registerModule</strong> 属性与 api， 后续的源码分析上会尝试实现。</p> <h1 id="build"><a href="#build" class="header-anchor">#</a> Build</h1> <p>接下来开始构建一个简易的 <strong>vuex</strong></p> <h2 id="application-structure-目录结构"><a href="#application-structure-目录结构" class="header-anchor">#</a> Application Structure 目录结构</h2> <div class="highlight"><div class="language-sh extra-class"><pre class="language-sh"><code>└── vuex
    └── src
        ├── index.js
        ├── store.js              <span class="token comment"># core code including install, Store</span>
        └── helpers               <span class="token comment"># helper functions including mapState, mapGetters, mapMutations, mapActions, createNamespacedHelpers</span>
        └── util.js
        ├── plugins
        │   └── logger.js
        └── module
            ├── module-collection.js
            └── module.js
</code></pre></div></div> <h2 id="核心入口文件"><a href="#核心入口文件" class="header-anchor">#</a> 核心入口文件</h2> <p>导出包含核心代码的对象</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Store<span class="token punctuation">,</span> install <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapState<span class="token punctuation">,</span> mapMutations<span class="token punctuation">,</span> mapGetters<span class="token punctuation">,</span> mapActions<span class="token punctuation">,</span> createNamespacedHelpers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./helpers'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Store<span class="token punctuation">,</span>
  install<span class="token punctuation">,</span>
  mapState<span class="token punctuation">,</span>
  mapGetters<span class="token punctuation">,</span>
  mapMutations<span class="token punctuation">,</span>
  mapActions<span class="token punctuation">,</span>
  createNamespacedHelpers
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  Store<span class="token punctuation">,</span>
  install<span class="token punctuation">,</span>
  mapState<span class="token punctuation">,</span>
  mapGetters<span class="token punctuation">,</span>
  mapMutations<span class="token punctuation">,</span>
  mapActions<span class="token punctuation">,</span>
  createNamespacedHelpers
<span class="token punctuation">}</span>
</code></pre></div></div> <h2 id="store-js"><a href="#store-js" class="header-anchor">#</a> store.js</h2> <h3 id="实现-install-方法"><a href="#实现-install-方法" class="header-anchor">#</a> 实现 install 方法</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">_Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue <span class="token operator">=</span> _Vue<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>store<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$store<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>Tip: 内部通过调用 <strong>Vue.mixin()</strong>，为所有组件注入 $store 属性</p></blockquote> <h3 id="实现-store-类"><a href="#实现-store-类" class="header-anchor">#</a> 实现 Store 类</h3> <h3 id="store-数据结构"><a href="#store-数据结构" class="header-anchor">#</a> Store 数据结构</h3> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">StoreOptions</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    state<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    getters<span class="token operator">?</span><span class="token operator">:</span> GetterTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    actions<span class="token operator">?</span><span class="token operator">:</span> ActionTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    mutations<span class="token operator">?</span><span class="token operator">:</span> MutationTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    modules<span class="token operator">?</span><span class="token operator">:</span> ModuleTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    plugins<span class="token operator">?</span><span class="token operator">:</span> Plugin<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    strict<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">class</span> <span class="token class-name">Store</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>options<span class="token operator">:</span> StoreOptions<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">readonly</span> state<span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> getters<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>

  <span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  dispatch<span class="token operator">:</span> Dispatch<span class="token punctuation">;</span>
  commit<span class="token operator">:</span> Commit<span class="token punctuation">;</span>

  subscribe<span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token keyword">extends</span> <span class="token class-name">MutationPayload</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">mutation<span class="token operator">:</span> <span class="token constant">P</span><span class="token punctuation">,</span> state<span class="token operator">:</span> <span class="token constant">S</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

  registerModule<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token keyword">module</span><span class="token operator">:</span> Module<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> ModuleOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  registerModule<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">module</span><span class="token operator">:</span> Module<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> ModuleOptions<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>Tip: 以上对源码上有一定出入，简化之后有些属性和方法有所删减和改动</p></blockquote> <p>依次执行步骤:</p> <ul><li>脚本引入时，确保 install 方法被调用，先判断是否挂载了全局属性 Vue</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Vue <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Window <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> Window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">install</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h4 id="构造函数内部先初始化实例属性和方法"><a href="#构造函数内部先初始化实例属性和方法" class="header-anchor">#</a> 构造函数内部先初始化实例属性和方法</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">this</span><span class="token punctuation">.</span>strict <span class="token operator">=</span> options<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      state<span class="token operator">:</span> options<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>getters <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mutations <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>actions <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div></div> <blockquote><p>Tip: <strong>this.vm</strong> 是核心，实现状态响应式，一旦发生改变，依赖的组件视图就会立即更新。</p></blockquote> <h4 id="getters"><a href="#getters" class="header-anchor">#</a> getters</h4> <p>类型为 GetterTree 调用 <strong>Object.create(null)</strong> 创建一个干净的对象，即原型链指向 null，没有原型对象的方法和属性，提高性能</p> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">GetterTree</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> Getter<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>mutations</strong>: MutationTree</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">MutationTree</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> Mutation<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="actions"><a href="#actions" class="header-anchor">#</a> actions</h5> <p>类型为 ActionTree</p> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ActionTree</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> Action<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="modules"><a href="#modules" class="header-anchor">#</a> modules</h5> <p>考虑到 state 对象下可能会有多个 modules，创建 <strong>ModuleCollection</strong> 格式化成想要的数据结构</p> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  namespaced<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  state<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">S</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  getters<span class="token operator">?</span><span class="token operator">:</span> GetterTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  actions<span class="token operator">?</span><span class="token operator">:</span> ActionTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  mutations<span class="token operator">?</span><span class="token operator">:</span> MutationTree<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  modules<span class="token operator">?</span><span class="token operator">:</span> ModuleTree<span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ModuleTree</span><span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> Module<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="get-state"><a href="#get-state" class="header-anchor">#</a> get state</h5> <p><strong>core</strong> 这里进行了依赖收集，将用户传入的 state 变为响应式数据，数据变化触发依赖的页面更新</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">get</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="subscribe"><a href="#subscribe" class="header-anchor">#</a> subscribe</h5> <p>订阅的事件在每一次 mutation 时发布</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><strong>replaceState</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="subs"><a href="#subs" class="header-anchor">#</a> subs</h5> <p>订阅事件的存储队列</p> <h5 id="plugins"><a href="#plugins" class="header-anchor">#</a> plugins</h5> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> plugins<span class="token operator">=</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">;</span>
  plugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=&gt;</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <p>结构为数组，暴露每一次 mutation 的钩子函数。每一个 Vuex 插件仅仅是一个函数，接收 唯一的参数 store，插件功能就是在mutation 调用时增加逻辑，如：
- <strong>createLogger</strong>  vuex/dist/logger 修改日志（内置）
- <strong>stateSnapShot</strong> 生成状态快照
- <strong>persists</strong> 数据持久化</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">persists</span> <span class="token operator">=</span> <span class="token parameter">store</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// mock data from server db</span>
  <span class="token keyword">let</span> local <span class="token operator">=</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'Vuex:state'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    store<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// mock 每一次数据变了之后就往数据库里存数据</span>
  store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">mutation<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'Vuex:state'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="committing"><a href="#committing" class="header-anchor">#</a> _committing</h5> <p>boolean 监听异步逻辑是否在 dispatch 调用</p> <h5 id="withcommit"><a href="#withcommit" class="header-anchor">#</a> _withCommit</h5> <p>函数接片，劫持mutation（commit） 触发函数。</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> committing <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_committing<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> committing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="strict"><a href="#strict" class="header-anchor">#</a> strict</h5> <p>源码中，在严格模式下，会深度监听状态异步逻辑的调用机制是否符合规范</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
        <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_committing<span class="token punctuation">,</span> <span class="token string">'不能异步调用'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          deep<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          sync<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></div> <blockquote><p>Tip: 生产环境下需要禁用 strict 模式，深度监听会消耗性能，核心是调用 Vue 的监听函数</p></blockquote> <h5 id="commit"><a href="#commit" class="header-anchor">#</a> commit</h5> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">commit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_withCommit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mutations<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="dispatch"><a href="#dispatch" class="header-anchor">#</a> dispatch</h5> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="registermodule-动态注册状态模块"><a href="#registermodule-动态注册状态模块" class="header-anchor">#</a> registerModule 动态注册状态模块</h5> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">registerModule</span><span class="token punctuation">(</span><span class="token parameter">moduleName<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_committing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    moduleName <span class="token operator">=</span> <span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">,</span> moduleName<span class="token punctuation">,</span> module<span class="token punctuation">.</span>rawModule<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h5 id="installmodule"><a href="#installmodule" class="header-anchor">#</a> installModule</h5> <p>工具方法，注册格式化后的数据，具体表现为: （注册）</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 
* @param {StoreOption} store 状态实例
* @param {state} rootState 根状态
* @param {Array&lt;String&gt;} path 父子模块名构成的数组
* @param {Object} rawModule 当前模块状态对应格式化后的数据：{ state, _raw, _children, state } 其中 _raw 是 options: { namespaced?, state, getter, mutations, actions, modules?, plugins, strict}
*/</span>
<span class="token keyword">function</span> <span class="token function">installModule</span><span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">,</span> rawModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">let</span> <span class="token punctuation">{</span> getters<span class="token punctuation">,</span> mutations<span class="token punctuation">,</span> actions <span class="token punctuation">}</span> <span class="token operator">=</span> rawModule<span class="token punctuation">.</span>_raw<span class="token punctuation">;</span>
  <span class="token keyword">let</span> root <span class="token operator">=</span> store<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>root<span class="token punctuation">;</span>
</code></pre></div></div> <ul><li><strong>子模块命名空间处理</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> namespace <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span> currentModuleName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// root._raw 对应的就是 当前模块的 option， 根模块没有 namespaced 属性跳过</span>
    root <span class="token operator">=</span> root<span class="token punctuation">.</span>_children<span class="token punctuation">[</span>currentModuleName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> str <span class="token operator">+</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>_raw<span class="token punctuation">.</span>namespaced <span class="token operator">?</span> currentModuleName <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <ul><li><strong>注册 state</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> parentState <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> root<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">,</span> rootState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// CORE：动态给跟状态添加新属性，需调用 Vue.set API，添加依赖</span>
      Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>parentState<span class="token punctuation">,</span> path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rawModule<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><strong>注册 getters</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>getters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>getters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>getters<span class="token punctuation">,</span> namespace <span class="token operator">+</span> type<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><strong>注册 mutations</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>mutations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>mutations<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> arr <span class="token operator">=</span> store<span class="token punctuation">.</span>mutations<span class="token punctuation">[</span>namespace <span class="token operator">+</span> type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>mutations<span class="token punctuation">[</span>namespace <span class="token operator">+</span> type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发布 subscribe 订阅的回调函数</span>
        store<span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">sub</span> <span class="token operator">=&gt;</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token operator">:</span> namespace <span class="token operator">+</span> type<span class="token punctuation">,</span>
          payload<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><strong>注册 actions</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">if</span> <span class="token punctuation">(</span>actions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foreach</span><span class="token punctuation">(</span>actions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> arr <span class="token operator">=</span> store<span class="token punctuation">.</span>actions<span class="token punctuation">[</span>namespace <span class="token operator">+</span> type<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>store<span class="token punctuation">.</span>actions<span class="token punctuation">[</span>namespace <span class="token operator">+</span> type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">payload</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><strong>递归处理子模块</strong></li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">foreach</span><span class="token punctuation">(</span>rawModule<span class="token punctuation">.</span>_children<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">moduleName<span class="token punctuation">,</span> rawModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">installModule</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> rootState<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">,</span> rawModule<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="modulecollection-类结构"><a href="#modulecollection-类结构" class="header-anchor">#</a> ModuleCollection 类结构</h3> <h4 id="constructor-构造函数"><a href="#constructor-构造函数" class="header-anchor">#</a> constructor 构造函数</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ModuleCollection</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <h4 id="register-实例方法"><a href="#register-实例方法" class="header-anchor">#</a> register 实例方法</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// rootModule: 为当前模块下的 StoreOption</span>
    <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> rootModuleOption</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> rawModule <span class="token operator">=</span> <span class="token punctuation">{</span>
        _raw<span class="token operator">:</span> rootModuleOption<span class="token punctuation">,</span>
        _children<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        state<span class="token operator">:</span> rootModuleOption<span class="token punctuation">.</span>state
      <span class="token punctuation">}</span>
      rootModuleOption<span class="token punctuation">.</span>rawModule <span class="token operator">=</span> rawModule<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>root <span class="token operator">=</span> rawModule<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 若 modules: a.modules.b =&gt; [a, b] =&gt; root._children.a._children.b</span>
        <span class="token keyword">let</span> parentModule <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> root<span class="token punctuation">.</span>_children<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        parentModule<span class="token punctuation">.</span>_children<span class="token punctuation">[</span>path<span class="token punctuation">[</span>path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> rawModule
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>rootModuleOption<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">foreach</span><span class="token punctuation">(</span>rootModuleOption<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">moduleName<span class="token punctuation">,</span> moduleOption</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>moduleName<span class="token punctuation">)</span><span class="token punctuation">,</span> moduleOption<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="helpers-js"><a href="#helpers-js" class="header-anchor">#</a> helpers.js</h3> <p>帮助文件中的四个函数都是通过接受对应要映射为对象的参数名，直接供组件内部使用。</p> <h4 id="mapstate"><a href="#mapstate" class="header-anchor">#</a> mapState</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">mapState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">stateName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">[</span>stateName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">[</span>stateName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>stateName<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">[</span>stateName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">[</span>stateName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <blockquote><p>参数 <strong>options</strong> 类型可以是:
- <strong>Array[string]</strong>, 如：[ 'count', 'list' ]
- <strong>Object</strong>, key 值为状态名，value 可以是 <strong>string</strong>, <strong>arrow function</strong>, <strong>normal function</strong>，其中常规函数，可以在内部访问到当前组件实例</p></blockquote> <h4 id="mapgetters"><a href="#mapgetters" class="header-anchor">#</a> mapGetters</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mapGetters</span><span class="token punctuation">(</span><span class="token parameter">namespace<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options <span class="token operator">=</span> namespace<span class="token punctuation">;</span>
      namespace <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      namespace <span class="token operator">+=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">getterName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>getterName<span class="token punctuation">)</span>
      obj<span class="token punctuation">[</span>getterName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">[</span>namespace <span class="token operator">+</span> getterName<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <h4 id="mapmutations"><a href="#mapmutations" class="header-anchor">#</a> mapMutations</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mapMutations</span><span class="token punctuation">(</span><span class="token parameter">namespace<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> namespace<span class="token punctuation">;</span>
    namespace <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    namespace <span class="token operator">+=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">mutationName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>mutationName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>namespace <span class="token operator">+</span> mutationName<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h4 id="mapactions"><a href="#mapactions" class="header-anchor">#</a> mapActions</h4> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mapActions</span><span class="token punctuation">(</span><span class="token parameter">namespace<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> namespace<span class="token punctuation">;</span>
    namespace <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    namespace <span class="token operator">+=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  options<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">actionName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>actionName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>namespace <span class="token operator">+</span> actionName<span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>以上后三个方法包含了子模块命名空间，参数解析如下：</p> <blockquote><p>参数1可选值，为子状态模块的命名空间
参数2为选项属性，类型同 mapState</p></blockquote> <h3 id="工具函数"><a href="#工具函数" class="header-anchor">#</a> 工具函数</h3> <h4 id="foreach"><a href="#foreach" class="header-anchor">#</a> foreach</h4> <p>处理对象键值对迭代函数处理</p> <h4 id="getstate"><a href="#getstate" class="header-anchor">#</a> getState</h4> <p>同步用户调用 replaceState 后，状态内部的新状态</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">foreach</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">getState</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newState<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> newState<span class="token punctuation">[</span>current<span class="token punctuation">]</span><span class="token punctuation">,</span> store<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <p>至此， vuex 源码的个人分析基本完结，因为是<strong>简版</strong>与源码会有一定的出入。
Feel free to tell me if there is any problem.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/stella/assets/js/app.f51058f0.js" defer></script><script src="/stella/assets/js/2.15e74eba.js" defer></script><script src="/stella/assets/js/18.30763b5e.js" defer></script><script src="/stella/assets/js/3.c735cdfb.js" defer></script>
  </body>
</html>
