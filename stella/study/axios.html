<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简介 | Hi, I&#39;m here</title>
    <meta name="description" content="Stella Blog">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="shortcut icon" type="image/x-icon" href="/stella/cute.gif">
    
    <link rel="preload" href="/stella/assets/css/0.styles.6825d706.css" as="style"><link rel="preload" href="/stella/assets/js/app.1c61ef4c.js" as="script"><link rel="preload" href="/stella/assets/js/2.fcbb7af2.js" as="script"><link rel="preload" href="/stella/assets/js/11.1f530080.js" as="script"><link rel="preload" href="/stella/assets/js/3.110e554a.js" as="script"><link rel="prefetch" href="/stella/assets/js/10.1fea8f0c.js"><link rel="prefetch" href="/stella/assets/js/12.cfbce4fc.js"><link rel="prefetch" href="/stella/assets/js/13.2ef5c543.js"><link rel="prefetch" href="/stella/assets/js/14.0fb24db4.js"><link rel="prefetch" href="/stella/assets/js/15.ecf49989.js"><link rel="prefetch" href="/stella/assets/js/16.e6fd138a.js"><link rel="prefetch" href="/stella/assets/js/17.28a4f1c9.js"><link rel="prefetch" href="/stella/assets/js/18.79f5c98e.js"><link rel="prefetch" href="/stella/assets/js/19.7ac56074.js"><link rel="prefetch" href="/stella/assets/js/20.f56356a5.js"><link rel="prefetch" href="/stella/assets/js/21.e425e9ac.js"><link rel="prefetch" href="/stella/assets/js/22.7206555d.js"><link rel="prefetch" href="/stella/assets/js/4.06261530.js"><link rel="prefetch" href="/stella/assets/js/5.ef4b734f.js"><link rel="prefetch" href="/stella/assets/js/6.7c458166.js"><link rel="prefetch" href="/stella/assets/js/7.1abb8f91.js"><link rel="prefetch" href="/stella/assets/js/8.cfd3f758.js"><link rel="prefetch" href="/stella/assets/js/9.efce92a0.js">
    <link rel="stylesheet" href="/stella/assets/css/0.styles.6825d706.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/stella/" class="home-link router-link-active"><!----> <span class="site-name">Hi, I'm here</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link router-link-exact-active router-link-active">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/interview.html" class="nav-link">
  interview
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/stella/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/stella/interview.html" class="nav-link">
  Interview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Study Analysis" class="dropdown-title"><span class="title">Study Analysis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/stella/study/express.html" class="nav-link">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/koa.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/axios.html" class="nav-link router-link-exact-active router-link-active">
  Axios
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/domdiff.html" class="nav-link">
  Vue DOM-Diff
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/mvvm.html" class="nav-link">
  Vue-MVVM
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ssr.html" class="nav-link">
  Vue-SSR
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/cz.html" class="nav-link">
  Cz
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/ws.html" class="nav-link">
  ws
</a></li><li class="dropdown-item"><!----> <a href="/stella/study/interview.html" class="nav-link">
  interview
</a></li></ul></div></div><div class="nav-item"><a href="/stella/resume.html" class="nav-link">
  Resume
</a></div><div class="nav-item"><a href="https://github.com/StellaYangF/StellaYangF.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>简介</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/stella/study/axios.html#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/axios.html#准备工作" class="sidebar-link">准备工作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/axios.html#首先，前端用-npx-create-react-app-axios-app-typescript-生成一个-ts-react-项目" class="sidebar-link">首先，前端用 npx create-react-app axios-app --typescript 生成一个 ts react 项目</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#接下来，搭建用-node-搭建一个后台服务器" class="sidebar-link">接下来，搭建用 node 搭建一个后台服务器</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#axios-库实现前后端的交互" class="sidebar-link">axios 库实现前后端的交互</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#安装前后端需要的模块" class="sidebar-link">安装前后端需要的模块</a></li></ul></li><li><a href="/stella/study/axios.html#使用" class="sidebar-link">使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/stella/study/axios.html#实现" class="sidebar-link">实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/axios.html#图解模型" class="sidebar-link">图解模型</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#类型声明文件" class="sidebar-link">类型声明文件</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#src-目录下创建-axios-目录，新增文件" class="sidebar-link">src 目录下创建 axios 目录，新增文件</a></li></ul></li><li><a href="/stella/study/axios.html#功能" class="sidebar-link">功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/stella/study/axios.html#request-请求" class="sidebar-link">request 请求</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#error-handling-错误处理" class="sidebar-link">error handling 错误处理</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#merge-options-合并选项" class="sidebar-link">merge options 合并选项</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#transform-request-response-转换请求、-响应" class="sidebar-link">transform request &amp; response 转换请求、 响应</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#intercept-request-response-拦截请求、响应" class="sidebar-link">intercept request &amp; response 拦截请求、响应</a></li><li class="sidebar-sub-header"><a href="/stella/study/axios.html#cancel-request-取消请求" class="sidebar-link">cancel request 取消请求</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p><em>Promise based HTTP client for the browser and node.js</em></p> <p><code>Axios</code> 是基于 Promise 的 HTTP 客户端，支持在浏览器端和 node.js 中使用。</p> <p>其本质就是一个函数，即 <code>Axios.prototype.request</code> 函数（绑定 <code>AxiosInstance</code> 后的），同时合并 <code>Axios.prototype</code> 和 <code>AxiosInstance</code> 对象上的属性和方法。该函数内部实例化了一个 <code>XMLHttpRequest</code> 对象，调用相关 <code>API</code> 实现请求和响应，最终返回一个 <code>promise</code> 对象。</p> <h2 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h2> <h3 id="首先，前端用-npx-create-react-app-axios-app-typescript-生成一个-ts-react-项目"><a href="#首先，前端用-npx-create-react-app-axios-app-typescript-生成一个-ts-react-项目" class="header-anchor">#</a> 首先，前端用 <code>npx create-react-app axios-app --typescript</code> 生成一个 ts <code>react</code> 项目</h3> <h3 id="接下来，搭建用-node-搭建一个后台服务器"><a href="#接下来，搭建用-node-搭建一个后台服务器" class="header-anchor">#</a> 接下来，搭建用 <code>node</code> 搭建一个后台服务器</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'http://localhost:3000'</span><span class="token punctuation">,</span><span class="token comment">// 设置跨越 react web服务器 端口号 3000</span>
        <span class="token string">'Access-Control-Allow-Credentials'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">'Access-Control-Allow-Methods'</span><span class="token operator">:</span> <span class="token string">'GET,POST, PUT, DELETE, OPTIONS'</span><span class="token punctuation">,</span>
        <span class="token string">'Access-Control-Allow-Headers'</span><span class="token operator">:</span> <span class="token string">'Content-Type,name'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post_timeout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> timeout <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    timeout <span class="token operator">=</span> timeout <span class="token operator">?</span>  <span class="token function">parseInt</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post_status'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    code <span class="token operator">=</span> code <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> code<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <h3 id="axios-库实现前后端的交互"><a href="#axios-库实现前后端的交互" class="header-anchor">#</a> <code>axios</code> 库实现前后端的交互</h3> <h3 id="安装前后端需要的模块"><a href="#安装前后端需要的模块" class="header-anchor">#</a> 安装前后端需要的模块</h3> <ul><li>前端库需要的模块
<ul><li><code>qs</code> 调用 <code>qs.stringify(object)</code> 将参数 对象转为 查询字符串</li> <li><code>parseHeaders</code> 解析后端传入的请求头字符串 =&gt; 对象格式</li></ul></li> <li>后端
<ul><li><code>express</code> 基于 <code>http</code> 实现的后端服务</li> <li><code>body-parser</code> 解析 json 请求体和表单请求体</li></ul></li></ul> <div class="highlight"><div class="language-bash extra-class"><pre class="language-bash"><code>npx create-react-app axios-app
<span class="token builtin class-name">cd</span> axios-app
<span class="token function">yarn</span> <span class="token function">add</span> axios qs parse-headers
<span class="token function">yarn</span> <span class="token function">add</span> express body-parser
</code></pre></div></div> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <p>发送 <code>get</code> 请求</p> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js 文件</span>
<span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'Stella'</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> baseUrl <span class="token operator">=</span> <span class="token string">'http://localhost:8000'</span><span class="token punctuation">;</span>

<span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>baseUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/get</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> user<span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>接下来，来分析分析 <code>axios</code> 调用过程以及 <code>.then</code> 成功回调中接收的相应结果，很显然这里的 <code>axios</code> 函数调用后返回的是一个 <code>promise</code> 对象</p> <h3 id="图解模型"><a href="#图解模型" class="header-anchor">#</a> 图解模型</h3> <img src="https://user-gold-cdn.xitu.io/2020/2/26/170811c60974b9bb?w=1329&amp;h=483&amp;f=png&amp;s=20239"> <h3 id="类型声明文件"><a href="#类型声明文件" class="header-anchor">#</a> 类型声明文件</h3> <p>index.d.ts</p> <ul><li><code>Cancel</code>：取消请求</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Cancel</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> reason<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><code>isCancel</code>：判断是否取消的函数</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isCancel</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value <span class="token keyword">instanceof</span> <span class="token class-name">Cancel</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><code>CancelToken</code>：基于 <code>Promise</code> 实现，将 <code>resolve</code> 函数调用赋给实例属性，成功状态改变交给了用户</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CancelToken</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> resolve<span class="token operator">:</span> any<span class="token punctuation">;</span>

    <span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            token<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">cancel</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">reason<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><code>Interceptor</code> 的两个参数，都为函数</li></ul> <div class="highlight"></div> <p>解析: <code>onFulfilled</code> 参数 <code>V</code> 类型 根据实例化的对象不同传入不同的参数， <code>request</code> 参数为 <code>AxiosRequestConfig</code> 统一对请求选项进行拦截处理， <code>response</code> 参数为 <code>AxiosResponse&lt;T&gt;</code></p> <ul><li><code>Interceptor</code>：拦截器</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    onFulfilled<span class="token operator">?</span><span class="token operator">:</span> onFulfilled<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
    onRejected<span class="token operator">?</span><span class="token operator">:</span> onRejected
<span class="token punctuation">}</span>
</code></pre></div></div> <p>解析：每个拦截器对象有两个属性，分别为成功和失败的函数，最终通过串行的方式给 <code>promise</code> 对象消费。</p> <div class="highlight"><ul><li><code>AxiosInterceptorManager</code>：<code>axios.interceptors.request</code> | <code>axios.interceptors.response</code> 的类</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">AxiosInterceptorManager</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> interceptors<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Interceptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 每个拦截器都有两个参数， 成功的回调 和失败的回调</span>
    <span class="token function">use</span><span class="token punctuation">(</span>onFulfilled<span class="token operator">?</span><span class="token operator">:</span> onFulfilled<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> onRejected<span class="token operator">?</span><span class="token operator">:</span> onRejected<span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            onFulfilled<span class="token punctuation">,</span>
            onRejected
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">eject</span><span class="token punctuation">(</span>index<span class="token operator">:</span>number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>     
</code></pre></div></div> <p>解析：</p> <ol><li><code>interceptors</code>：数组类型，请求、响应的拦截通过调用 <code>use</code> 加入 <code>Interceptor</code> 类型，调用 <code>eject</code> 弹出加入的 <code>Interceptor</code> 类型为 null</li> <li><code>use</code>：向 <code>interceptors</code> 数组中添加一个 <code>Interceptor</code>，返回值为当前添加的下标 <code>interceptors.length - 1</code></li> <li><code>eject</code>：接收要被弹出的 <code>Interceptor</code> 下标，将该下标在数组中对应的 <code>interceptor</code> 设置为 <code>null</code></li></ol> <ul><li><code>Interceptors</code>：拦截器类型</li></ul> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptors</span> <span class="token punctuation">{</span>
    request<span class="token operator">:</span> AxiosInterceptorManager<span class="token operator">&lt;</span>AxiosRequestConfig<span class="token operator">&gt;</span>
    response<span class="token operator">:</span> AxiosInterceptorManager<span class="token operator">&lt;</span>AxiosResponse<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <ul><li><code>axios</code> 请求方法及其器属性</li></ul> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AxiosInstance</span> <span class="token punctuation">{</span>
  <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>config<span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
  interceptors<span class="token operator">:</span> Interceptors<span class="token punctuation">;</span>
  defaults<span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">;</span>
  CancelToken<span class="token operator">:</span> CancelToken<span class="token punctuation">;</span>
  <span class="token function">isCancel</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  <span class="token keyword">get</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> config<span class="token operator">?</span><span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">R</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <p>逐一分析 <code>axios</code> 属性、方法</p> <ol><li><code>&lt;T = any&gt;(config: AxiosRequestConfig): Promise&lt;AxiosResponse&lt;T&gt;&gt;</code>：请求函数，接收 <code>AxiosRequestConfig</code>，发送请求</li> <li><code>interceptors:</code>：拦截器，</li></ol> <ul><li><code>AxiosRequestConfig</code> 请求配置选项类型</li></ul> <p>规定用户传入的参数可以是以下类型</p> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AxiosRequestConfig</span> <span class="token punctuation">{</span>
  url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  method<span class="token operator">?</span><span class="token operator">:</span> Methods<span class="token punctuation">;</span>
  params<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  <span class="token comment">// params: Record&lt;string, any&gt;;</span>
  headers<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  data<span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  timeout<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  transformRequest<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">requestData<span class="token operator">:</span><span class="token builtin">any</span><span class="token punctuation">,</span> headers<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  transformResponse<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">responseData<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  cancelToken<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre></div></div> <p>逐一分析下 <code>AxiosRequestConfig</code> 各个属性/ 方法的用途吧，划重点：这里传入的配置选项就是给 <code>XMLHttpRequest</code> 对象的（以下都用 <code>request</code> 简称）各种API使用哒</p> <ol><li><code>url</code>: 请求路径的一部分 协议 + 域名 + 端口号</li> <li><code>method</code>: 请求的方法名</li> <li><code>params</code>: 请求路径的 查询字符串，调用 <code>qs.stringify()</code> 将对象类型的 <code>params</code> 转为字符串格式，如：</li></ol> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>传入的
params <span class="token operator">=</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'Stella'</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
格式化后：
params <span class="token operator">=</span> <span class="token string">'name=Stella&amp;password=123456'</span><span class="token punctuation">;</span>
</code></pre></div></div> <ol><li><code>headers</code>: 请求头信息</li> <li><code>data</code>: 请求方法为 <code>POST</code> 时的请求体</li> <li><code>timeout</code>: 请求超时时长，用于超时的</li></ol> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code>request<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div></div> <ol start="7"><li><p><code>transformRequest</code>: 这是一个用于转换请求的方法，接收两个参数，分别是用户传入的 <code>data</code> 和 <code>headers</code>，可对这个属性进行操作，返回值为处理后的 <code>data</code></p></li> <li><p><code>transformResponse</code>: 这是一个用于转换响应的方法，接收的参数为请求响应 <code>response</code> 的完整结果，返回值为处理后的 <code>response</code></p></li> <li><p><code>cancelToken</code>: 这个不需要自己实现，值为 <code>axios.CancelToken.source().token</code>，就是一个 <code>Promise</code> 实例对象，在实例化的时候并没有立即让其状态 <code>state</code> 变为 <code>FULFILLED</code> 或 <code>REJECTED</code>，也就是没有执行 <code>resolve</code> |  <code>reject</code> <code>函数，而是将resolve</code> 函数赋值给了 <code>CancelToken</code> 实例的方法。用户可调用 <code>axios.CancelToken.source().cancel(reason)</code> 传入 <code>reason</code> 变为成功态</p></li></ol> <ul><li><code>AxiosResponse</code> 响应类型</li></ul> <p>接收泛型 <code>T</code>, 传入的动态数据类型会作为 <code>Promise</code> 类的执行器函数 <code>executor(resolve, reject)</code> 的第一个成功函数调用的参数，一旦变为成功态，<code>axios</code> 请求函数调用结果（就是刚才的 new 出来的 promise 对象），就能 <code>.then(onFulfilled)</code> 获取到哦</p> <div class="highlight"><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AxiosResponse</span><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  status<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  statusText<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  headers<span class="token operator">?</span> <span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  config<span class="token operator">?</span><span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">;</span>
  request<span class="token operator">?</span><span class="token operator">:</span> XMLHttpRequest<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h3 id="src-目录下创建-axios-目录，新增文件"><a href="#src-目录下创建-axios-目录，新增文件" class="header-anchor">#</a> src 目录下创建 axios 目录，新增文件</h3> <ul><li>Axios.ts</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AxiosRequestConfig<span class="token punctuation">,</span> AxiosResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> AxiosInterceptorManager<span class="token punctuation">,</span> <span class="token punctuation">{</span> Interceptor<span class="token punctuation">,</span> Interceptors <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./AxiosInterceptorManager'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> qs <span class="token keyword">from</span> <span class="token string">'qs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> parseHeaders <span class="token keyword">from</span> <span class="token string">'parse-headers'</span><span class="token punctuation">;</span>

<span class="token comment">// merge options</span>
<span class="token keyword">const</span> defaults<span class="token operator">:</span> AxiosRequestConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
    common<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 针对所有的请求生效</span>
      accept<span class="token operator">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span> <span class="token comment">// 指定服务器返回 JSON 格式的数据</span>
      name<span class="token operator">:</span> <span class="token string">'Stella'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> getStyleMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'delete'</span><span class="token punctuation">,</span> <span class="token string">'options'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> postStyleMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'put'</span><span class="token punctuation">,</span> <span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'patch'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
getStyleMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>defaults<span class="token punctuation">.</span>headers<span class="token operator">!</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
postStyleMethods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>defaults<span class="token punctuation">.</span>headers<span class="token operator">!</span><span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> allMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>getStyleMethods<span class="token punctuation">,</span> <span class="token operator">...</span>postStyleMethods<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Axios</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> defaults<span class="token operator">:</span> AxiosRequestConfig <span class="token operator">=</span> defaults<span class="token punctuation">;</span>
  <span class="token keyword">public</span> interceptors<span class="token operator">:</span> Interceptors <span class="token operator">=</span> <span class="token punctuation">{</span>
    request<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AxiosInterceptorManager</span><span class="token operator">&lt;</span>AxiosRequestConfig<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    response<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AxiosInterceptorManager</span><span class="token operator">&lt;</span>AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  request<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>config<span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>AxiosRequestConfig <span class="token operator">|</span> AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>headers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>transformRequest <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span>data <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">transformRequest</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>data<span class="token punctuation">,</span> config<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> chain<span class="token operator">:</span> Interceptor<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      onFulfilled<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dispatchRequest<span class="token punctuation">,</span>
      onRejected<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      interceptor <span class="token operator">&amp;&amp;</span> chain<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">interceptor</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      interceptor <span class="token operator">&amp;&amp;</span> chain<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> promise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> onRejected <span class="token punctuation">}</span> <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      promise <span class="token operator">=</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  dispatchRequest<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>config<span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> method<span class="token operator">=</span> <span class="token string">'get'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> data<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
      <span class="token keyword">let</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> params <span class="token operator">==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        params <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>url<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'?'</span> <span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span> <span class="token operator">+</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      request<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token operator">!</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      request<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
      request<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// h5 API request.onload readystate = 4 status = 200</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> request<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> response<span class="token operator">:</span> AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
              data<span class="token operator">:</span> request<span class="token punctuation">.</span>response <span class="token operator">?</span> request<span class="token punctuation">.</span>response <span class="token operator">:</span> request<span class="token punctuation">.</span>responseText<span class="token punctuation">,</span>
              status<span class="token operator">:</span> request<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
              statusText<span class="token operator">:</span> request<span class="token punctuation">.</span>statusText<span class="token punctuation">,</span>
              headers<span class="token operator">:</span> <span class="token function">parseHeaders</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              config<span class="token punctuation">,</span>
              request<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>transformResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              response <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">transformResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request failed with status code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>request<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//  POST method</span>
      <span class="token comment">// headers &amp;&amp; Object.keys(headers).forEach(key =&gt; request.setRequestHeader(key, headers![key]));</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// headers:</span>
        <span class="token comment">//   common: {accept: &quot;application/json&quot;}</span>
        <span class="token comment">//   get: {}</span>
        <span class="token comment">//   head: {}</span>
        <span class="token comment">//   delete: {}</span>
        <span class="token comment">//   options: {}</span>
        <span class="token comment">//   put: {Content-Type: &quot;application/json&quot;}</span>
        <span class="token comment">//   post: {Content-Type: &quot;application/json&quot;}</span>
        <span class="token comment">//   patch: {Content-Type: &quot;application/json&quot;}</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'common'</span> <span class="token operator">||</span> allMethods<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'common'</span> <span class="token operator">||</span> key <span class="token operator">===</span> config<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key2 <span class="token keyword">in</span> headers<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key2<span class="token punctuation">,</span> headers<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span>key2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> request<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> headers<span class="token operator">!</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> body<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> body <span class="token operator">=</span> data<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> 
      <span class="token comment">/**
       * 错误处理
       *  - 网络异常 request.onerror
       *  - 超时异常 request.ontimeout
       *  - 错误状态码 request.status === 0
       */</span>

      request<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">net::ERR_INTERNET_DISCONNECTED</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout<span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">timeout of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timeout<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms exceeded</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// cancelToken</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        config<span class="token punctuation">.</span>cancelToken<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">R</span> <span class="token operator">=</span> AxiosResponse<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>url<span class="token operator">:</span> string<span class="token punctuation">,</span> config<span class="token operator">?</span><span class="token operator">:</span> AxiosRequestConfig<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>AxiosRequestConfig <span class="token operator">|</span> <span class="token constant">R</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>config<span class="token punctuation">,</span> url<span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>config<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <ul><li>index.js</li></ul> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Axios <span class="token keyword">from</span> <span class="token string">'./Axios'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AxiosInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CancelToken<span class="token punctuation">,</span> isCancel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./cancel'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> createInstance<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AxiosInstance <span class="token punctuation">{</span>
  <span class="token keyword">let</span> context<span class="token operator">:</span> Axios<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Axios</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 绑定 request this 永远指向当前实例</span>
  <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 合并 Axios 原型对象 和 实例属性到 request 函数对象上。</span>
  instance <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token class-name">Axios</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> instance <span class="token keyword">as</span> AxiosInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> axios <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span>CancelToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
axios<span class="token punctuation">.</span>isCancel <span class="token operator">=</span> isCancel<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> axios<span class="token punctuation">;</span>
</code></pre></div></div> <h2 id="功能"><a href="#功能" class="header-anchor">#</a> 功能</h2> <h3 id="request-请求"><a href="#request-请求" class="header-anchor">#</a> request 请求</h3> <h3 id="error-handling-错误处理"><a href="#error-handling-错误处理" class="header-anchor">#</a> error handling 错误处理</h3> <h3 id="merge-options-合并选项"><a href="#merge-options-合并选项" class="header-anchor">#</a> merge options 合并选项</h3> <h3 id="transform-request-response-转换请求、-响应"><a href="#transform-request-response-转换请求、-响应" class="header-anchor">#</a> transform request &amp; response 转换请求、 响应</h3> <h3 id="intercept-request-response-拦截请求、响应"><a href="#intercept-request-response-拦截请求、响应" class="header-anchor">#</a> intercept request &amp; response 拦截请求、响应</h3> <img src="">
拦截器有两种情况:
可以多次调用 `.use`，
- 对请求的拦截 `axios.interceptors.request`
- 对响应的拦截 `axios.interceptors.response`
<h3 id="cancel-request-取消请求"><a href="#cancel-request-取消请求" class="header-anchor">#</a> cancel request 取消请求</h3> <div class="highlight"><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// todos...</span>
</code></pre></div></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/stella/assets/js/app.1c61ef4c.js" defer></script><script src="/stella/assets/js/2.fcbb7af2.js" defer></script><script src="/stella/assets/js/11.1f530080.js" defer></script><script src="/stella/assets/js/3.110e554a.js" defer></script>
  </body>
</html>
